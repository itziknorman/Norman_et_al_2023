This folder contains the ripple detection algorithm

Prior to the detection hippocampal electrode were identified using the following procedure:

*Electrode localizaion*

A preoperative T1-weighted 1mm isometric scan was co-registered to a post-operative CT through the procedure described previously (Norman et al., 2021), which is also extensively documented in the iELVis toolbox (Groppe et al., 2017). Individual recoding sites were identified visually on the co-registered CT, and were marked in each subjectâ€™s preoperative MRI native space, using BioImage Suite (Papademetris et al., 2006). After processing the MRI in Freesurfer (Fischl, 2012) to segment the cortex and the hippocampus (Iglesias et al., 2015), we superimposed the hippocampal electrodes onto a 3D reconstruction of the hippocampal formation, allowing us to determine the precise subfield localization of each recording site within the native space of each patient's brain.

*Preprocessing of the iEEG signal* 

The raw iEEG signal is first examined statistically to identify and exclude noisy or corrupted channels from the analysis. Channels with voltage values, voltage derivatives, or RMS in the 99th percentile that were >5 standard deviations greater than the rest of the electrodes were marked for exclusion after visual inspection in the time and frequency domains. Preprocessing included converting all healthy iEEG channels into bipolar derivations. Electrodes in the hippocampus were referenced relative to a nearby white-matter contact, that was identified anatomically using FreeSurfer's segmentation (Fischl, 2012). The obtained bipolar signals are then notch-filtered to remove 50 Hz power line interference using a zero-lag linear-phase Hamming-windowed FIR band-stop filter (3 Hz wide).

*Hippocampal Ripples Detection* 

To detect hippocampal ripples, we use a slightly modified version of the procedure described in (Norman et al., 2021). 
This detection is preformed on hippocampal electrodes located within <2 mm from the hippocampal subfields CA1, CA2, CA3 or subiculum, i.e., the main stations on the hippocampal output pathways where physiological ripple oscillations are most prominently observed (Chrobak et al., 1996; Oliva et al., 2016). We delineate and reconstruct the individual hippocampal subfields based on the structural MRI scans of the patients (Iglesias et al., 2015). Prior to ripple detection, a reference signal from a nearby white-matter contact is subtracted to eliminate common noise (as mentioned in the preproc section above). The iEEG time series is then filtered between 70-180Hz (using a zero-lag linear-phase Hamming windowed FIR filter), and the instantaneous analytic amplitude is computed using a Hilbert transform.  Based on our previously published procedure (Norman et al., 2021), the mean and std of the ripple-band ampltiude time-series are first robustly estimated using Least-Median-Squares (LMS) (Seheult et al., 1989; see functoin robustAverage.m) to detect extreme timepoints (i.e., transients >4 SD above the mean) and clip them to 4 std above the mean to minimize ripple-rate induced biasing (this step make sure that the std estimation will not be affected by the number of ripple events or by transient artifacts). The clipped signal is then squared and smoothed (Kaiser-window FIR low-pass filter with 40 Hz cutoff), and the mean and SD are re-computed (based on the clipped signal) across the entire experimental duration to define the threshold for ripple detection. Events from the original (squared but unclipped) signal that exceeded 4 SD above baseline are then selected as candidate ripple events. Event duration are expanded until ripple power falls below 2 SD. Events shorter than 20ms or longer than 200ms are excluded. Adjacent events with less than 30ms separation (peak-to-peak) are merged. Finally, ripple peaks are aligned to the trough (of the non-rectified signal) closest to the peak power.

*avoiding artifacts*

A control detection is performed on the common average signal computed across all iEEG channels. Hippocampal ripple events that coincided with common average ripple-band peaks are removed, thus avoiding erroneous detection of transient electrical and muscular artifacts that tend to appear simultaneously on multiple channels (Fiederer et al., 2016; Liu et al., 2022). 
To distinguish between physiological ripples and other high-frequency oscillations (HFOs) related to epilepsy (Bragin et al., 2010), we discard any candidate ripple events that occur within 500 ms from inter-ictal epileptic discharges (IEDs). The detection of IEDs is done using two complementary methods: an automated line-length algorithm based on (Baud et al., 2018, doi: 10.1093/neuros/nyx480, see LLspikedetector.m) and a band-limited power analysis similar to (Smith et al., 2022, doi: 10.7554/eLife.73541). For the latter, the raw hippocampal iEEG signal is first filtered between 20-40Hz using a zero-lag linear-phase Hamming windowed FIR filter. Next, the filtered signal is rectified, squared, smoothed and z-scored. Events that exceeded 8 standard deviations (SD) are identified as putative IEDs. 
